# BruteForm

ぷよぷよの連鎖形を総当たり探索し、最適な配置を見つけるためのRust製GUIアプリケーションです。

## 概要

- **総当たりタブ**：指定条件で連鎖形を総当たり探索し、JSONL形式で出力
- **連鎖生成タブ**：対話的に連鎖形を構築し、目標盤面に向けて最適な手順を探索

## システム要件・実行

- **OS**: Windows
- **Rust**: 1.70以上推奨

```bash
cargo run --release --bin puyo_gui
```

## 機能詳細

### 1. 総当たりタブ

盤面条件を指定して、指定した連鎖数以上の配置を全探索します。

#### セル種別（6列×14段）

- **`A`～`M`**: 絶対指定セル（A=0個固定、B=1個固定、…、M=12個固定）
- **`N`**: 任意個数（0個以上）
- **`X`**: 1個以上必須
- **`R`, `G`, `B`, `Y`**: 色固定（赤、緑、青、黄）
- **`・`**: 空マス（0個固定）

#### 探索パラメータ

| パラメータ | デフォルト | 説明 |
|-----------|-----------|------|
| **連鎖閾値** | 7 | この値以上の連鎖数を持つ配置のみ出力 |
| **形キャッシュ上限** | 300（千単位） | LRUキャッシュの上限サイズ |
| **早期終了: 進捗停滞比** | 0.0 | 進捗が停滞したら探索を打ち切る（0.0=無効） |

#### 探索モード

- **4個消しモード**（チェックボックス）:
  - 有効: 4個でぷよが消える場合のみ有効（**5個以上で消えた場合は除外**）
  - 無効: 4個以上で消える場合すべて有効（通常モード）

#### **重要：盤面制約**

1. **Abs系（A～M）**:
   - 指定した個数が**厳密に**その位置に配置される
   - 列全体で積み上げ計算される（重力考慮済み）
   - **隣接するAbs系セルは異なる色にする必要がある**（4色彩色問題）
   - 4色彩色が不可能な配置の場合、探索は実行されない

2. **Any (`N`)**:
   - 0個以上の任意個数が配置可能

3. **AnyNonZero (`X`)**:
   - 必ず1個以上が配置される

4. **Fixed系（R/G/B/Y）**:
   - 色が固定される（個数は1個固定）

5. **Blank (`・`)**:
   - 何も配置されない（空マス確定）
   - **上方に何も積めない**という強制的な制約

6. **列高さの制約**:
   - 各列は下から順に詰められる（重力適用済み）
   - 空中にぷよは浮かない
   - 14段を超える配置は不可

7. **連鎖判定**:
   - 同色4個以上が上下左右に連結すると消える
   - 連鎖閾値以上の配置のみ結果に含まれる

8. **1連鎖目の制約**:
   - **消えるぷよの隣に空白マスが存在する必要がある**（発火可能性の確認）
   - **消えるぷよが単一の連結成分である必要がある**（E1単一連結チェック）
   - **消えるぷよの上に乗っているぷよの数が1個以下である列が少なくとも1列必要**
   - 全ての列で消えるぷよの上に2個以上乗っている配置は棄却される

#### 出力

- **形式**: JSONL（JSON Lines）、デフォルトで`results.jsonl`
- **内容**: 盤面配置、連鎖数、正規化ハッシュ値、ミラー対称情報

### 2. 連鎖生成タブ

対話的に連鎖形を構築し、目標盤面の達成を支援します。

#### ワークフロー

1. **実盤面でぷよを配置**（ランダムまたは目標配置）
2. **目標盤面を更新**（ビーム探索で最適な連鎖形を計算）
3. **連鎖検出**（目標盤面の連鎖情報を取得）
4. **頭伸ばし**（連鎖数を増やすための最適化）

#### 各機能の概要とパラメータ

**ぷよペア配置**:
- ランダム配置/目標配置（目標盤面に最も近づく配置を自動選択）
- **制約**: 連鎖中またはアニメーション中は無効

**目標盤面更新**（ビーム探索）:
- パラメータ: ビーム幅（1～64、デフォルト10）、最大深さ（1～20、デフォルト8）
- **制約**: 連鎖中またはアニメーション中は無効

**連鎖検出（目標盤面）**:
- 目標盤面で連鎖シミュレーションを実行し、1連鎖目と最終連鎖を可視化
- **制約**: 連鎖中またはアニメーション中は無効、目標盤面が空の場合はエラー

**フリートップ削除**:
- 1連鎖目で消えるぷよのうち、上に何も乗っていない列から1個削除
- **制約**: 連鎖情報が未取得、またはフリートップ列がない場合はエラー

**頭伸ばし**:
- フリートップ削除で空けたマスを含む周囲9マスに、総当たりでぷよを配置
- 連鎖数が増加する最良の配置を採用し、目標盤面を更新
- **制約**: フリートップ削除が未実行の場合はエラー

#### **重要：連鎖生成タブの制約まとめ**

**操作が無効化される条件**:
- `lock=true`（連鎖中）
- `anim.is_some()`（アニメーション中）

**各機能の前提条件**:

| 機能 | 前提条件 |
|------|---------|
| ランダム配置 | 操作可能（ロックなし） |
| 目標配置 | 操作可能 + 目標盤面が設定済み |
| 目標盤面更新 | 操作可能 |
| 連鎖検出 | 操作可能 + 目標盤面が設定済み |
| フリートップ削除 | 操作可能 + 連鎖情報あり + フリートップ列あり |
| 頭伸ばし | 操作可能 + 連鎖情報あり + フリートップ削除済み |
| 戻る / 初手に戻る | 操作可能 + undo_stack.len() > 1 |

**連鎖発火の制約**:
- 4個以上連結
- 目標盤面が設定されている場合、**完成している必要がある**

**頭伸ばしの詳細制約**:
1. **フリートップ制約**（各列の最上部にのみ配置可能）
2. **目標盤面完成チェック**（全てのぷよが含まれている）
3. **1連鎖目の連結数 < 6個**
4. **フリートップ列が1列以上残る**
5. 連鎖が発生する
6. **ベースラインを超える連鎖数**

**目標配置の評価関数**:
- 基本スコア: 目標盤面とのマッチング度
- 色上書きペナルティ: -100点/マス
- フリートップ列制約: -5000点
- 早期連鎖ペナルティ: -10000点

## トラブルシューティング

**探索が遅い場合**:
- 総当たりタブ: 形キャッシュ上限を増やす、計測を無効化、早期終了を設定
- 連鎖生成タブ: 詳細ログを無効化、ビーム幅/最大深さを減らす

**頭伸ばしが成功しない場合**:
- フリートップ列が複数あることを確認
- 詳細ログを有効にして棄却理由を確認

**メモリ不足の場合**:
- 形キャッシュ上限を減らす（300→100）
- 盤面の制約を強くする（`N`を減らし、`A`～`M`や`・`を増やす）
